#! /bin/sh /usr/share/dpatch/dpatch-run
## CVE-2008-3639_sgi_filter_overflow.dpatch by Martin Pitt <mpitt@debian.org>
##
## DP: Fix buffer overflow due to unchecked boundary in the SGI filter.
## DP: (CVE-2008-3639, STR #2918)
@DPATCH@
diff -urNad lenny~/filter/image-sgilib.c lenny/filter/image-sgilib.c
--- lenny~/filter/image-sgilib.c	2008-07-12 00:48:49.000000000 +0200
+++ lenny/filter/image-sgilib.c	2008-10-08 09:07:25.000000000 +0200
@@ -640,13 +640,14 @@
     if (ch & 128)
     {
       for (i = 0; i < count; i ++, row ++, xsize --, length ++)
-        *row = getc(fp);
+        if (xsize > 0)
+	  *row = getc(fp);
     }
     else
     {
       ch = getc(fp);
       length ++;
-      for (i = 0; i < count; i ++, row ++, xsize --)
+      for (i = 0; i < count && xsize > 0; i ++, row ++, xsize --)
         *row = ch;
     }
   }
@@ -685,13 +686,14 @@
     if (ch & 128)
     {
       for (i = 0; i < count; i ++, row ++, xsize --, length ++)
-        *row = getshort(fp);
+        if (xsize > 0)
+	  *row = getshort(fp);
     }
     else
     {
       ch = getshort(fp);
       length ++;
-      for (i = 0; i < count; i ++, row ++, xsize --)
+      for (i = 0; i < count && xsize > 0; i ++, row ++, xsize --)
         *row = ch;
     }
   }
